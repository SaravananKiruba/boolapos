<UserControl x:Class="Page_Navigation_App.View.RateMaster"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             mc:Ignorable="d"
             d:DesignHeight="650"
             d:DesignWidth="1000">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="350"/>
        </Grid.ColumnDefinitions>

        <!-- Rate Entry Form -->
        <mah:MetroHeader Grid.Column="0"
                        Header="Metal Rate Entry"
                        Margin="0,0,20,0">
            <mah:MetroContentControl>
                <StackPanel>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <ComboBox Grid.Column="0"
                                  Margin="0,0,10,0"
                                  ItemsSource="{Binding MetalTypes}"
                                  SelectedItem="{Binding SelectedRate.MetalType}"
                                  mah:TextBoxHelper.Watermark="Metal Type"
                                  Style="{StaticResource MahApps.Styles.ComboBox}"/>

                        <ComboBox Grid.Column="1"
                                  Margin="0,0,10,0"
                                  ItemsSource="{Binding Purities}"
                                  SelectedItem="{Binding SelectedRate.Purity}"
                                  mah:TextBoxHelper.Watermark="Purity"
                                  Style="{StaticResource MahApps.Styles.ComboBox}"/>

                        <mah:NumericUpDown Grid.Column="2"
                                          Value="{Binding SelectedRate.Rate}"
                                          mah:TextBoxHelper.Watermark="Rate (per gram)"
                                          Style="{StaticResource MahApps.Styles.NumericUpDown}"
                                          StringFormat="N2"
                                          Minimum="0"/>
                    </Grid>

                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <mah:NumericUpDown Grid.Column="0"
                                          Margin="0,0,10,0"
                                          Value="{Binding SelectedRate.PurchaseRate}"
                                          mah:TextBoxHelper.Watermark="Purchase Rate"
                                          Style="{StaticResource MahApps.Styles.NumericUpDown}"
                                          StringFormat="N2"
                                          Minimum="0"/>

                        <mah:NumericUpDown Grid.Column="1"
                                          Value="{Binding SelectedRate.SaleRate}"
                                          mah:TextBoxHelper.Watermark="Sale Rate"
                                          Style="{StaticResource MahApps.Styles.NumericUpDown}"
                                          StringFormat="N2"
                                          Minimum="0"/>
                    </Grid>

                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <ComboBox Grid.Column="0"
                                  Margin="0,0,10,0"
                                  ItemsSource="{Binding Sources}"
                                  SelectedItem="{Binding SelectedRate.Source}"
                                  mah:TextBoxHelper.Watermark="Rate Source"
                                  Style="{StaticResource MahApps.Styles.ComboBox}"/>

                        <mah:DateTimePicker Grid.Column="1"
                                           SelectedDateTime="{Binding SelectedRate.ValidUntil}"
                                           mah:TextBoxHelper.Watermark="Valid Until"
                                           Style="{StaticResource MahApps.Styles.DateTimePicker}"/>
                    </Grid>

                    <TextBox Text="{Binding SelectedRate.Notes}"
                             mah:TextBoxHelper.Watermark="Notes"
                             Style="{StaticResource MahApps.Styles.TextBox}"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             Height="60"
                             Margin="0,0,0,10"/>

                    <StackPanel Orientation="Horizontal" 
                              HorizontalAlignment="Right">
                        <Button Content="Clear"
                                Margin="0,0,10,0"
                                Style="{StaticResource MahApps.Styles.Button}"
                                Command="{Binding ClearCommand}"/>
                        
                        <Button Content="Save"
                                Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                                Command="{Binding AddOrUpdateCommand}"/>
                    </StackPanel>
                </StackPanel>
            </mah:MetroContentControl>
        </mah:MetroHeader>

        <!-- Current Rates Display -->
        <mah:MetroHeader Grid.Column="1"
                        Header="Live Rates">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding Rates}"
                            Margin="0,10,0,0">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <mah:MetroHeader Margin="0,0,0,10">
                                <mah:MetroHeader.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding MetalType}" FontWeight="Bold"/>
                                    </DataTemplate>
                                </mah:MetroHeader.HeaderTemplate>
                                <Grid Margin="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Purity}" 
                                                   Opacity="0.7"/>
                                        <TextBlock Margin="0,5,0,0">
                                            <Run Text="â‚¹"/>
                                            <Run Text="{Binding Rate, StringFormat=N2}"/>
                                            <Run Text="/g"/>
                                        </TextBlock>
                                    </StackPanel>
                                    <iconPacks:PackIconMaterial Grid.Column="1"
                                                             Kind="TrendingUp"
                                                             Width="24"
                                                             Height="24"
                                                             VerticalAlignment="Center"
                                                             Foreground="{StaticResource PrimaryBrush}"/>
                                </Grid>
                            </mah:MetroHeader>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </mah:MetroHeader>

        <!-- Rate History -->
        <mah:MetroHeader Grid.Row="1"
                        Grid.Column="0"
                        Grid.ColumnSpan="2"
                        Header="Rate History"
                        Margin="0,20,0,0">
            <DataGrid ItemsSource="{Binding RateHistory}"
                      AutoGenerateColumns="False"
                      Style="{StaticResource MahApps.Styles.DataGrid}"
                      GridLinesVisibility="Horizontal"
                      IsReadOnly="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Date" 
                                      Binding="{Binding EffectiveDate, StringFormat=d}"
                                      Width="120"/>
                    <DataGridTextColumn Header="Metal Type" 
                                      Binding="{Binding MetalType}"
                                      Width="120"/>
                    <DataGridTextColumn Header="Purity" 
                                      Binding="{Binding Purity}"
                                      Width="100"/>
                    <DataGridTextColumn Header="Rate" 
                                      Binding="{Binding Rate, StringFormat=N2}"
                                      Width="100"/>
                    <DataGridTextColumn Header="Purchase Rate" 
                                      Binding="{Binding PurchaseRate, StringFormat=N2}"
                                      Width="120"/>
                    <DataGridTextColumn Header="Sale Rate" 
                                      Binding="{Binding SaleRate, StringFormat=N2}"
                                      Width="120"/>
                    <DataGridTextColumn Header="Updated By" 
                                      Binding="{Binding UpdatedBy}"
                                      Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </mah:MetroHeader>
    </Grid>
</UserControl>